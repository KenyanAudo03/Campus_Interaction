{% extends "base.html" %}

{% block title %}Feed{% endblock %}

{% block content %}
<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="polite" aria-atomic="true"
        data-mdb-autohide="true" data-mdb-delay="3000">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2"></i>
            <strong class="me-auto toast-title"></strong>
            <button type="button" class="btn-close" data-mdb-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<!-- Main Feed Container -->
<div class="row g-4">
    <!-- Left Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
        <!-- Search Card -->
        <div class="card mb-4 border-0 shadow-2">
            <div class="card-body">
                <div class="input-group input-group-lg shadow-1 rounded-5">
                    <span class="input-group-text border-0 bg-white">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control border-0" id="searchInput" placeholder="Search posts..."
                        aria-label="Search posts">
                </div>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="card border-0 shadow-2 mb-4">
            <div class="card-body">
                <h5 class="card-title d-flex align-items-center mb-3">
                    <i class="fas fa-filter me-2 text-primary"></i>
                    <span class="fw-bold">Filters</span>
                </h5>
                <div class="list-group list-group-flush">
                    <button class="list-group-item list-group-item-action active px-3 py-3 rounded-3 mb-2"
                        data-mdb-ripple-init data-mdb-ripple-color="primary" data-filter="all">
                        <i class="fas fa-stream me-2"></i> All Posts
                        <span class="badge rounded-pill bg-primary float-end">New</span>
                    </button>
                    <button class="list-group-item list-group-item-action px-3 py-3 rounded-3 mb-2" data-mdb-ripple-init
                        data-mdb-ripple-color="primary" data-filter="following">
                        <i class="fas fa-user-friends me-2"></i> Following
                    </button>
                    <button class="list-group-item list-group-item-action px-3 py-3 rounded-3" data-mdb-ripple-init
                        data-mdb-ripple-color="primary" data-filter="trending">
                        <i class="fas fa-fire me-2"></i> Trending
                    </button>
                </div>
            </div>
        </div>

        <!-- Suggested Users Card -->
        <div class="card border-0 shadow-2">
            <div class="card-body">
                <h5 class="card-title d-flex align-items-center mb-3">
                    <i class="fas fa-user-plus me-2 text-primary"></i>
                    <span class="fw-bold">Suggested Users</span>
                </h5>
                <div id="suggestedUsers" class="list-group list-group-flush">
                    <!-- Loading State -->
                    <div class="placeholder-glow">
                        {% for i in '123'|make_list %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="placeholder rounded-circle me-3" style="width: 48px; height: 48px;"></div>
                            <div class="flex-grow-1">
                                <div class="placeholder col-7 mb-1"></div>
                                <div class="placeholder col-4"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <!-- Error State -->
                    <div class="d-none text-center py-4" id="suggestedUsersError">
                        <i class="fas fa-exclamation-circle text-danger mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-0">Unable to load suggestions</p>
                        <button class="btn btn-link btn-sm" onclick="loadSuggestedUsers()">
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Feed -->
    <div class="col-lg-6">
        <!-- Create Post Card -->
        <div class="card border-0 shadow-2 hover-shadow-3 mb-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <img src="{{ user.profile.get_avatar_url }}" class="rounded-circle shadow-2 me-3"
                        alt="{{ user.username }}'s avatar" width="48" height="48" style="object-fit: cover;">
                    <a href="{% url 'feeds:create_post' %}"
                        class="form-control form-control-lg bg-light border-0 rounded-pill text-muted"
                        style="cursor: pointer;" data-mdb-ripple-init>
                        <i class="far fa-edit me-2"></i>What's on your mind?
                    </a>
                </div>
                <div class="d-flex justify-content-around mt-3 pt-3 border-top">
                    <button class="btn btn-link text-muted" data-mdb-ripple-init data-mdb-ripple-color="dark">
                        <i class="fas fa-image me-2"></i>Photo
                    </button>
                    <button class="btn btn-link text-muted" data-mdb-ripple-init data-mdb-ripple-color="dark">
                        <i class="fas fa-video me-2"></i>Video
                    </button>
                    <button class="btn btn-link text-muted" data-mdb-ripple-init data-mdb-ripple-color="dark">
                        <i class="fas fa-smile me-2"></i>Feeling
                    </button>
                </div>
            </div>
        </div>

        <!-- Posts Container -->
        <div id="postsContainer">
            <!-- Loading State -->
            <div class="placeholder-glow">
                {% for i in '12'|make_list %}
                <div class="card border-0 shadow-2 mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="placeholder rounded-circle me-3" style="width: 48px; height: 48px;"></div>
                            <div class="flex-grow-1">
                                <div class="placeholder col-4 mb-1"></div>
                                <div class="placeholder col-3"></div>
                            </div>
                        </div>
                        <div class="placeholder col-12 mb-3" style="height: 100px;"></div>
                        <div class="placeholder col-3"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Error State -->
            <div class="d-none text-center py-5" id="postsError">
                <i class="fas fa-exclamation-circle text-danger mb-3" style="font-size: 3rem;"></i>
                <h5 class="text-muted">Unable to load posts</h5>
                <button class="btn btn-primary mt-2" onclick="loadPosts()">
                    Try Again
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center d-none my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading more posts...</span>
            </div>
        </div>

        <!-- Load More Button -->
        <button id="loadMoreBtn" class="btn btn-light w-100 mb-4 d-none shadow-2" data-mdb-ripple-init>
            Load More
        </button>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
        <div class="card border-0 shadow-2">
            <div class="card-body">
                <h5 class="card-title d-flex align-items-center mb-3">
                    <i class="fas fa-chart-line me-2 text-primary"></i>
                    <span class="fw-bold">Trending Posts</span>
                </h5>
                <div id="trendingPosts">
                    {% for post in trending_posts %}
                    <div class="card bg-light border-0 mb-3 hover-shadow rounded-3">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center mb-2">
                                <img src="{{ post.user.profile.get_avatar_url }}" class="rounded-circle me-2"
                                    alt="{{ post.user.username }}'s avatar" width="32" height="32"
                                    style="object-fit: cover;">
                                <h6 class="card-subtitle mb-0 text-muted">{{ post.user.username }}</h6>
                            </div>
                            <p class="card-text small">{{ post.content|truncatechars:100 }}</p>
                            <div class="d-flex justify-content-between text-muted small">
                                <span><i class="fas fa-heart text-danger me-1"></i>{{ post.likes_count }}</span>
                                <span><i class="fas fa-eye text-primary me-1"></i>{{ post.views_count }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Post Template -->
<template id="postTemplate">
    <div class="card border-0 shadow-2 hover-shadow-3 mb-4 post-card" data-post-id="">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <a href="#" class="user-profile-link me-3">
                        <img src="" alt="" class="rounded-circle shadow-2 post-avatar" width="48" height="48"
                            style="object-fit: cover;">
                    </a>
                    <div>
                        <div class="d-flex align-items-center">
                            <h6 class="fw-bold mb-0 post-username"></h6>
                            <span class="badge bg-primary ms-2 user-course d-none"></span>
                        </div>
                        <small class="text-muted d-block post-date"></small>
                        <small class="text-muted user-campus d-none"></small>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link text-dark" type="button" data-mdb-dropdown-init aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu shadow-3">
                        <li>
                            <button class="dropdown-item view-engagement" data-type="likes">
                                <i class="fas fa-heart me-2 text-danger"></i>View Likes
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item view-engagement" data-type="views">
                                <i class="fas fa-eye me-2 text-primary"></i>View Views
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item view-engagement" data-type="comments">
                                <i class="fas fa-comment me-2 text-success"></i>View Comments
                            </button>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <button class="dropdown-item post-delete">
                                <i class="fas fa-trash me-2 text-danger"></i>Delete
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="post-content mb-3"></div>
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex gap-3">
                    <button class="btn btn-link text-muted p-0 post-like-btn" data-mdb-ripple-init>
                        <i class="far fa-heart me-1"></i>
                        <span class="post-likes-count">0</span>
                    </button>
                    <button class="btn btn-link text-muted p-0 post-comment-btn" data-mdb-ripple-init>
                        <i class="far fa-comment me-1"></i>
                        <span class="post-comments-count">0</span>
                    </button>
                    <button class="btn btn-link text-muted p-0 post-share-btn" data-mdb-ripple-init>
                        <i class="far fa-share-square me-1"></i>Share
                    </button>
                </div>
                <small class="text-muted">
                    <i class="far fa-eye me-1"></i>
                    <span class="post-views-count">0</span> views
                </small>
            </div>
        </div>
    </div>
</template>

<!-- Modals -->
<!-- Engagement Modal -->
<div class="modal fade" id="engagementModal" tabindex="-1" aria-labelledby="engagementModalLabel" aria-hidden="true"
    data-mdb-backdrop="static">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="engagementModalLabel">Post Engagement</h5>
                <button type="button" class="btn-close" data-mdb-modal-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="engagement-list">
                    <!-- Loading State -->
                    <div class="placeholder-glow engagement-loading">
                        {% for i in '123'|make_list %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="placeholder rounded-circle me-2" style="width: 40px; height: 40px;"></div>
                            <div class="flex-grow-1">
                                <div class="placeholder col-4 mb-1"></div>
                                <div class="placeholder col-3"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <!-- Error State -->
                    <div class="d-none text-center py-4 engagement-error">
                        <i class="fas fa-exclamation-circle text-danger mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-0">Unable to load engagement data</p>
                        <button class="btn btn-link btn-sm reload-engagement">
                            Try Again
                        </button>
                    </div>
                </div>
                <div class="text-center mt-3 load-more-engagement d-none">
                    <button class="btn btn-light btn-sm shadow-2" data-mdb-ripple-init>
                        Load More
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comment Template -->
<template id="commentTemplate">
    <div class="comment mb-3">
        <div class="d-flex">
            <img src="" alt="" class="rounded-circle shadow-1 me-2 comment-avatar" width="32" height="32"
                style="object-fit: cover;">
            <div class="flex-grow-1">
                <div class="bg-light rounded-4 p-3">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <h6 class="fw-bold mb-0 comment-username"></h6>
                        <div class="dropdown comment-options">
                            <button class="btn btn-link btn-sm text-muted p-0" type="button" data-mdb-dropdown-init>
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-3">
                                <li>
                                    <button class="dropdown-item comment-delete">
                                        <i class="fas fa-trash me-2 text-danger"></i>Delete
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item comment-report">
                                        <i class="fas fa-flag me-2 text-warning"></i>Report
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <p class="mb-0 comment-content"></p>
                </div>
                <div class="d-flex align-items-center mt-2">
                    <small class="text-muted comment-date me-3"></small>
                    <button class="btn btn-link btn-sm text-muted p-0 me-3 comment-like-btn" data-mdb-ripple-init>
                        <i class="far fa-heart me-1"></i>
                        <span class="comment-likes-count">0</span>
                    </button>
                    <button class="btn btn-link btn-sm text-muted p-0 comment-reply-btn" data-mdb-ripple-init>
                        <i class="far fa-reply me-1"></i>Reply
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true"
    data-mdb-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">Report Content</h5>
                <button type="button" class="btn-close" data-mdb-modal-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm" class="needs-validation" novalidate>
                    <input type="hidden" id="reportContentId">
                    <input type="hidden" id="reportContentType">
                    <div class="form-outline mb-4">
                        <select class="form-select" id="reportType" required>
                            <option value="">Select a reason...</option>
                            <option value="spam">Spam or Misleading</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="harassment">Harassment or Hate Speech</option>
                            <option value="misinformation">False Information</option>
                            <option value="other">Other</option>
                        </select>
                        <label class="form-label" for="reportType">Reason for reporting</label>
                        <div class="invalid-feedback">Please select a reason for reporting.</div>
                    </div>
                    <div class="form-outline mb-4">
                        <textarea class="form-control" id="reportDescription" rows="3"></textarea>
                        <label class="form-label" for="reportDescription">Additional Details (Optional)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-mdb-modal-dismiss="modal"
                    data-mdb-ripple-init>Cancel</button>
                <button type="button" class="btn btn-primary" id="submitReport" data-mdb-ripple-init>Submit
                    Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true"
    data-mdb-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Post</h5>
                <button type="button" class="btn-close" data-mdb-modal-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-around mb-4">
                    <button class="btn btn-floating btn-primary" data-mdb-ripple-init>
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="btn btn-floating btn-info" data-mdb-ripple-init>
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="btn btn-floating btn-success" data-mdb-ripple-init>
                        <i class="fab fa-whatsapp"></i>
                    </button>
                    <button class="btn btn-floating btn-primary" data-mdb-ripple-init>
                        <i class="fab fa-telegram"></i>
                    </button>
                </div>
                <div class="form-outline">
                    <input type="text" id="shareLink" class="form-control" readonly>
                    <label class="form-label" for="shareLink">Share Link</label>
                </div>
                <button class="btn btn-light w-100 mt-3" id="copyShareLink" data-mdb-ripple-init>
                    <i class="far fa-copy me-2"></i>Copy Link
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    // Initialize core components and setup
    document.addEventListener('mdbReady', function() {
    try {
        // Initialize tooltips if they exist
        const tooltips = document.querySelectorAll('[data-mdb-toggle="tooltip"]');
        if (tooltips.length > 0) {
            tooltips.forEach(function(tooltipTrigger) {
                new mdb.Tooltip(tooltipTrigger);
            });
        }

        // Initialize modals if they exist
        const modals = document.querySelectorAll('.modal');
        if (modals.length > 0) {
            modals.forEach(modalElement => {
                new mdb.Modal(modalElement);
            });
        }

        // Initialize dropdowns if they exist
        const dropdowns = document.querySelectorAll('.dropdown-toggle');
        if (dropdowns.length > 0) {
            dropdowns.forEach(function(dropdownTrigger) {
                new mdb.Dropdown(dropdownTrigger);
            });
        }

        // Toast notification setup
        const notificationToast = document.getElementById('notificationToast');
        if (notificationToast) {
            const toast = new mdb.Toast(notificationToast);
            window.showNotification = function (title, message, type = 'success') {
                const toastHeader = notificationToast.querySelector('.toast-header');
                const toastBody = notificationToast.querySelector('.toast-body');

                // Update toast content
                toastHeader.innerHTML = `
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close" data-mdb-dismiss="toast"></button>
            `;
                toastBody.textContent = message;

                // Set toast style based on type
                notificationToast.classList.remove('bg-success', 'bg-danger', 'text-white');
                if (type === 'error') {
                    notificationToast.classList.add('bg-danger', 'text-white');
                } else {
                    notificationToast.classList.add('bg-success', 'text-white');
                }

                toast.show();
            };
        }

        // Post template setup
        const postTemplate = document.querySelector('.post-card');
        if (postTemplate) {
            postTemplate.style.display = 'none';
            window.createPostElement = function (postData) {
                const postElement = postTemplate.cloneNode(true);
                postElement.style.display = 'block';
                postElement.setAttribute('post-id', postData.id);

                // Set post content
                postElement.querySelector('.post-avatar').src = postData.user.avatar_url;
                postElement.querySelector('.post-username').textContent = postData.user.username;
                if (postData.user.course) {
                    const courseElement = postElement.querySelector('.user-course');
                    courseElement.textContent = postData.user.course;
                    courseElement.classList.remove('d-none');
                }

                // Set timestamps
                const timeElements = postElement.querySelectorAll('.small');
                timeElements[0].textContent = postData.created_at;
                timeElements[1].textContent = postData.updated_at;

                // Set post content and engagement counts
                postElement.querySelector('.post-content').innerHTML = postData.content;
                postElement.querySelector('.post-likes-count').textContent = postData.likes_count;
                postElement.querySelector('.post-comments-count').textContent = postData.comments_count;
                postElement.querySelector('.post-views-count').textContent = postData.views_count;

                return postElement;
            };
        }

        // Initialize post loading
        loadPosts();

        // Initialize suggested users
        loadSuggestedUsers();

    } catch (error) {
        console.error('Error initializing MDB components:', error);
    }
    });

    // Post loading functionality
    let postsPage = 1;
    let loadingPosts = false;
    let hasMorePosts = true;

    async function loadPosts() {
        if (loadingPosts || !hasMorePosts) return;

        const postsContainer = document.getElementById('postsContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const postsError = document.getElementById('postsError');

        try {
            loadingPosts = true;
            loadingSpinner.classList.remove('d-none');
            postsError.classList.add('d-none');

            const response = await fetch(`/api/posts/?page=${postsPage}`);
            if (!response.ok) throw new Error('Failed to load posts');

            const data = await response.json();
            if (data.results.length === 0) {
                hasMorePosts = false;
                return;
            }

            data.results.forEach(post => {
                const postElement = window.createPostElement(post);
                postsContainer.appendChild(postElement);
            });

            postsPage++;
        } catch (error) {
            console.error('Error loading posts:', error);
            postsError.classList.remove('d-none');
        } finally {
            loadingPosts = false;
            loadingSpinner.classList.add('d-none');
        }
    }


    // Infinite scroll implementation
    const observerOptions = {
        root: null,
        rootMargin: '100px',
        threshold: 0.1
    };

    const loadMoreObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !loadingPosts && hasMorePosts) {
                loadPosts();
            }
        });
    }, observerOptions);

    // Start observing the loading spinner
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadMoreObserver.observe(loadingSpinner);
    }

    // Post interactions
    async function handleLikePost(postId) {
        try {
            const response = await fetch(`/api/posts/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            });

            if (!response.ok) throw new Error('Failed to like post');

            const data = await response.json();
            const post = document.querySelector(`[post-id="${postId}"]`);
            if (post) {
                const likesCount = post.querySelector('.post-likes-count');
                likesCount.textContent = data.likes_count;

                // Toggle like button state
                const likeButton = post.querySelector('.like-button');
                if (data.is_liked) {
                    likeButton.classList.add('active', 'text-primary');
                } else {
                    likeButton.classList.remove('active', 'text-primary');
                }
            }
        } catch (error) {
            console.error('Error liking post:', error);
            showNotification('Error', 'Failed to like post', 'error');
        }
    }

    // Comments functionality
    async function loadComments(postId, page = 1) {
        try {
            const response = await fetch(`/api/posts/${postId}/comments/?page=${page}`);
            if (!response.ok) throw new Error('Failed to load comments');

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error loading comments:', error);
            throw error;
        }
    }

    function createCommentElement(comment) {
        const template = document.querySelector('.comment');
        const commentElement = template.cloneNode(true);

        commentElement.querySelector('.comment-avatar').src = comment.user.avatar_url;
        commentElement.querySelector('.comment-username').textContent = comment.user.username;
        commentElement.querySelector('small').textContent = comment.created_at;
        commentElement.querySelector('.comment-content').textContent = comment.content;
        commentElement.querySelector('.comment-likes-count').textContent = comment.likes_count;

        // Show delete option if comment is by current user
        if (comment.is_owner) {
            commentElement.querySelector('.comment-options').classList.remove('d-none');
        }

        return commentElement;
    }

    async function handleAddComment(postId, content) {
        try {
            const response = await fetch(`/api/posts/${postId}/comments/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ content })
            });

            if (!response.ok) throw new Error('Failed to add comment');

            const comment = await response.json();
            const commentElement = createCommentElement(comment);

            // Update comment count
            const post = document.querySelector(`[post-id="${postId}"]`);
            const commentsCount = post.querySelector('.post-comments-count');
            commentsCount.textContent = parseInt(commentsCount.textContent) + 1;

            return commentElement;
        } catch (error) {
            console.error('Error adding comment:', error);
            throw error;
        }
    }

    // Engagement modal handling
    const engagementModal = document.getElementById('engagementModal');
    if (engagementModal) {
        engagementModal.addEventListener('show.mdb.modal', async function (event) {
            const button = event.relatedTarget;
            const type = button.getAttribute('data-engagement-type');
            const postId = button.closest('.post-card').getAttribute('post-id');

            const modalTitle = engagementModal.querySelector('.modal-title');
            const modalList = engagementModal.querySelector('.engagement-list');
            const loadingElement = engagementModal.querySelector('.engagement-loading');
            const errorElement = engagementModal.querySelector('.engagement-error');

            modalTitle.textContent = type === 'likes' ? 'Likes' : 'Views';
            modalList.innerHTML = '';
            loadingElement.classList.remove('d-none');
            errorElement.classList.add('d-none');

            try {
                const response = await fetch(`/api/posts/${postId}/${type}/`);
                if (!response.ok) throw new Error(`Failed to load ${type}`);

                const data = await response.json();

                data.results.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'd-flex align-items-center mb-3';
                    userElement.innerHTML = `
                    <img src="${user.avatar_url}" class="rounded-circle me-2" width="40" height="40" style="object-fit: cover;">
                    <div class="flex-grow-1">
                        <h6 class="fw-bold mb-0">${user.username}</h6>
                        ${user.course ? `<span class="small text-muted">${user.course}</span>` : ''}
                    </div>
                `;
                    modalList.appendChild(userElement);
                });
            } catch (error) {
                console.error(`Error loading ${type}:`, error);
                errorElement.classList.remove('d-none');
            } finally {
                loadingElement.classList.add('d-none');
            }
        });
    }

    // Suggested users functionality
    async function loadSuggestedUsers() {
        const container = document.getElementById('suggestedUsers');
        const errorElement = document.getElementById('suggestedUsersError');

        try {
            const response = await fetch('/api/suggested-users/');
            if (!response.ok) throw new Error('Failed to load suggested users');

            const data = await response.json();

            container.innerHTML = data.results.map(user => `
            <div class="d-flex align-items-center mb-3">
                <img src="${user.avatar_url}" class="rounded-circle me-3" 
                     width="48" height="48" style="object-fit: cover;">
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0">${user.username}</h6>
                    ${user.course ? `<span class="small text-muted">${user.course}</span>` : ''}
                </div>
                <button class="btn btn-primary btn-rounded btn-sm follow-button" 
                        data-user-id="${user.id}">
                    ${user.is_following ? 'Following' : 'Follow'}
                </button>
            </div>
        `).join('');
        } catch (error) {
            console.error('Error loading suggested users:', error);
            errorElement.classList.remove('d-none');
        }
    }

    // Follow/Unfollow functionality
    async function handleFollowUser(userId, button) {
        try {
            const response = await fetch(`/api/users/${userId}/follow/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (!response.ok) throw new Error('Failed to update follow status');

            const data = await response.json();
            button.textContent = data.is_following ? 'Following' : 'Follow';

            if (data.is_following) {
                button.classList.add('btn-secondary');
                button.classList.remove('btn-primary');
            } else {
                button.classList.add('btn-primary');
                button.classList.remove('btn-secondary');
            }

            showNotification(
                'Success',
                `Successfully ${data.is_following ? 'followed' : 'unfollowed'} user`,
                'success'
            );
        } catch (error) {
            console.error('Error updating follow status:', error);
            showNotification('Error', 'Failed to update follow status', 'error');
        }
    }

    // Share functionality
    const shareModal = document.getElementById('shareModal');
    if (shareModal) {
        shareModal.addEventListener('show.mdb.modal', function (event) {
            const button = event.relatedTarget;
            const postId = button.closest('.post-card').getAttribute('post-id');
            const shareUrl = `${window.location.origin}/posts/${postId}/`;

            const linkInput = shareModal.querySelector('input');
            linkInput.value = shareUrl;
        });

        // Copy link functionality
        const copyButton = shareModal.querySelector('.copy-link');
        if (copyButton) {
            copyButton.addEventListener('click', function () {
                const linkInput = shareModal.querySelector('input');
                linkInput.select();
                document.execCommand('copy');

                showNotification('Success', 'Link copied to clipboard', 'success');
            });
        }
    }

    // Global event delegation for all interactions
    document.addEventListener('click', function (event) {
        const target = event.target;

        // Like button handler
        if (target.closest('.like-button')) {
            event.preventDefault();
            const postId = target.closest('.post-card').getAttribute('post-id');
            handleLikePost(postId);
        }

        // Follow button handler
        if (target.classList.contains('follow-button')) {
            const userId = target.dataset.userId;
            handleFollowUser(userId, target);
        }

        // Retry buttons handler
        if (target.hasAttribute('data-retry')) {
            const retryType = target.getAttribute('data-retry');
            switch (retryType) {
                case 'posts':
                    loadPosts();
                    document.getElementById('postsError').classList.add('d-none');
                    break;
                case 'suggested-users':
                    loadSuggestedUsers();
                    document.getElementById('suggestedUsersError').classList.add('d-none');
                    break;
            }
        }
    });

    // Report functionality
    const reportModal = document.getElementById('reportModal');
    if (reportModal) {
        const form = reportModal.querySelector('form');
        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            const reason = form.querySelector('select').value;
            const details = form.querySelector('textarea').value;
            const contentId = reportModal.getAttribute('data-content-id');
            const contentType = reportModal.getAttribute('data-content-type');

            try {
                const response = await fetch('/api/report/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        content_type: contentType,
                        content_id: contentId,
                        reason: reason,
                        details: details
                    })
                });

                if (!response.ok) throw new Error('Failed to submit report');

                showNotification('Success', 'Report submitted successfully', 'success');
                const modalInstance = mdb.Modal.getInstance(reportModal);
                modalInstance.hide();
                form.reset();
            } catch (error) {
                console.error('Error submitting report:', error);
                showNotification('Error', 'Failed to submit report', 'error');
            }
        });
    }

</script>
{% endblock %}

