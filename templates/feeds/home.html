{% extends "base.html" %}

{% block title %}Feed{% endblock %}

{% block content %}
<!-- Feed Container -->
<div class="row">
    <!-- Left Sidebar -->
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Filters</h5>
                <div class="list-group list-group-light">
                    <button class="list-group-item list-group-item-action active" data-filter="all">
                        <i class="fas fa-stream me-2"></i> All Posts
                    </button>
                    <button class="list-group-item list-group-item-action" data-filter="following">
                        <i class="fas fa-user-friends me-2"></i> Following
                    </button>
                    <button class="list-group-item list-group-item-action" data-filter="trending">
                        <i class="fas fa-fire me-2"></i> Trending
                    </button>
                </div>
            </div>
        </div>

        <!-- Suggested Users Card -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Suggested Users</h5>
                <div id="suggestedUsers" class="list-group list-group-light">
                    <!-- Suggested users will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Feed -->
    <div class="col-lg-6">
        <!-- Create Post Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex">
                    <img src="{{ user.profile.get_avatar_url }}" class="rounded-circle me-2"
                        style="width: 40px; height: 40px;">
                    <a href="{% url 'feeds:create_post' %}" class="form-control text-muted" style="cursor: pointer;">
                        What's on your mind?
                    </a>
                </div>
            </div>
        </div>

        <!-- Posts Container -->
        <div id="postsContainer">
            <!-- Posts will be loaded here -->
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Load More Button -->
        <button id="loadMoreBtn" class="btn btn-light w-100 mb-4 d-none">
            Load More
        </button>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Trending Posts</h5>
                <div id="trendingPosts">
                    {% for post in trending_posts %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">{{ post.user.username }}</h6>
                            <p class="card-text">{{ post.content|truncatechars:100 }}</p>
                            <div class="d-flex justify-content-between text-muted">
                                <small><i class="fas fa-heart"></i> {{ post.likes_count }}</small>
                                <small><i class="fas fa-eye"></i> {{ post.views_count }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Post Template -->
<template id="postTemplate">
    <div class="card mb-4 post-card" data-post-id="">
        <div class="card-body">
            <!-- Post Header -->
            <div class="d-flex justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <img src="" alt="" class="rounded-circle me-2 post-avatar" style="width: 40px; height: 40px;">
                    <div>
                        <h6 class="mb-0 post-username"></h6>
                        <small class="text-muted post-date"></small>
                    </div>
                </div>
                <div class="dropdown post-options">
                    <button class="btn btn-link text-dark" type="button" data-mdb-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><button class="dropdown-item post-delete"><i class="fas fa-trash me-2"></i>Delete</button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Post Content -->
            <p class="post-content"></p>
            <div class="post-media"></div>

            <!-- Post Stats -->
            <div class="d-flex justify-content-between text-muted mb-2">
                <small class="post-likes"><i class="fas fa-heart"></i> <span>0</span> likes</small>
                <small class="post-comments"><i class="fas fa-comment"></i> <span>0</span> comments</small>
                <small class="post-views"><i class="fas fa-eye"></i> <span>0</span> views</small>
            </div>

            <!-- Post Actions -->
            <div class="border-top border-bottom py-2 mb-3">
                <div class="d-flex justify-content-around">
                    <button class="btn btn-link text-dark like-btn">
                        <i class="far fa-heart"></i> Like
                    </button>
                    <button class="btn btn-link text-dark comment-btn">
                        <i class="far fa-comment"></i> Comment
                    </button>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="comments-section">
                <!-- Comments Toggle -->
                <div class="comments-toggle mb-3 d-none">
                    <button class="btn btn-link text-dark p-0">
                        <i class="fas fa-chevron-down me-1"></i>
                        View previous comments
                    </button>
                </div>

                <!-- Comments Container -->
                <div class="comments-container"></div>

                <!-- Comment Form -->
                <div class="comment-form mt-3">
                    <div class="d-flex">
                        <img src="{{ user.profile.get_avatar_url }}" class="rounded-circle me-2"
                            style="width: 32px; height: 32px;">
                        <div class="flex-grow-1 position-relative">
                            <input type="text" class="form-control comment-input" placeholder="Write a comment...">
                            <div class="position-absolute end-0 top-50 translate-middle-y me-2 d-none comment-actions">
                                <button class="btn btn-link btn-sm text-muted p-0 me-2 cancel-comment">
                                    Cancel
                                </button>
                                <button class="btn btn-primary btn-sm px-3 submit-comment" disabled>
                                    Reply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Comment Template -->
<template id="commentTemplate">
    <div class="comment mb-3">
        <div class="d-flex">
            <img src="" alt="" class="rounded-circle me-2 comment-avatar" style="width: 32px; height: 32px;">
            <div class="flex-grow-1">
                <div class="bg-light rounded-3 p-2">
                    <h6 class="mb-1 comment-username"></h6>
                    <p class="mb-1 comment-content"></p>
                </div>
                <div class="d-flex align-items-center mt-1">
                    <small class="text-muted comment-date me-3"></small>
                    <button class="btn btn-link btn-sm text-muted p-0 me-3 comment-like-btn">
                        Like
                    </button>
                    <button class="btn btn-link btn-sm text-muted p-0 comment-reply-btn">
                        Reply
                    </button>
                </div>
            </div>
            <!-- Comment Options -->
            <div class="dropdown comment-options ms-2">
                <button class="btn btn-link btn-sm text-muted" type="button" data-mdb-toggle="dropdown">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><button class="dropdown-item comment-delete"><i class="fas fa-trash me-2"></i>Delete</button>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentFilter = 'all';
    let hasMore = true;
    let isLoading = false;
    let loadedComments = new Map(); // Track loaded comments for each post

    // Initialize the feed
    $(document).ready(function () {
        loadPosts();
        loadSuggestedUsers();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Filter buttons
        $('.list-group-item').click(function () {
            $('.list-group-item').removeClass('active');
            $(this).addClass('active');
            currentFilter = $(this).data('filter');
            currentPage = 1;
            $('#postsContainer').empty();
            loadPosts();
        });

        // Load more button
        $('#loadMoreBtn').click(function () {
            if (hasMore && !isLoading) {
                currentPage++;
                loadPosts();
            }
        });

        // Infinite scroll
        $(window).scroll(function () {
            if ($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
                if (hasMore && !isLoading) {
                    currentPage++;
                    loadPosts();
                }
            }
        });
    }

    function loadPosts() {
        if (isLoading) return;
        isLoading = true;
        $('#loadingSpinner').removeClass('d-none');

        $.get(`/feeds/api/feed/list/?page=${currentPage}&filter=${currentFilter}`)
            .done(function (response) {
                if (response.status === 'success') {
                    response.posts.forEach(post => {
                        appendPost(post);
                    });
                    hasMore = response.has_next;
                    $('#loadMoreBtn').toggleClass('d-none', !hasMore);
                }
            })
            .fail(function (xhr) {
                console.error('Error loading posts:', xhr);
            })
            .always(function () {
                isLoading = false;
                $('#loadingSpinner').addClass('d-none');
            });
    }

    function appendPost(postData) {
        const template = document.getElementById('postTemplate');
        const postElement = template.content.cloneNode(true);
        const postCard = postElement.querySelector('.post-card');

        // Set post data
        postCard.dataset.postId = postData.id;
        postCard.querySelector('.post-avatar').src = postData.user.avatar_url;
        postCard.querySelector('.post-username').textContent = postData.user.username;
        postCard.querySelector('.post-date').textContent = formatDate(postData.created_at);
        postCard.querySelector('.post-content').textContent = postData.content;
        postCard.querySelector('.post-likes span').textContent = postData.likes_count;
        postCard.querySelector('.post-comments span').textContent = postData.comments_count;
        postCard.querySelector('.post-views span').textContent = postData.views_count;

        // Update like button state if user has liked
        if (postData.is_liked) {
            postCard.querySelector('.like-btn i').classList.replace('far', 'fas');
            postCard.querySelector('.like-btn').classList.add('text-danger');
        }

        // Handle media
        if (postData.image_url) {
            const img = document.createElement('img');
            img.src = postData.image_url;
            img.className = 'img-fluid rounded mb-3';
            postCard.querySelector('.post-media').appendChild(img);
        } else if (postData.video_url) {
            const video = document.createElement('video');
            video.src = postData.video_url;
            video.className = 'w-100 rounded mb-3';
            video.controls = true;
            postCard.querySelector('.post-media').appendChild(video);
        }

        // Show/hide delete button based on ownership
        if (postData.user.id !== window.currentUserId) {
            postCard.querySelector('.post-options').remove();
        }

        // Setup event listeners
        setupPostInteractions(postCard, postData.id);

        $('#postsContainer').append(postCard);
    }

    function setupPostInteractions(postElement, postId) {
        const card = $(postElement);

        // Like button
        card.find('.like-btn').click(function () {
            const btn = $(this);
            const icon = btn.find('i');
            const likesCount = card.find('.post-likes span');

            $.post(`/feeds/api/posts/${postId}/like/`)
                .done(function (response) {
                    if (response.status === 'success') {
                        likesCount.text(response.likes_count);
                        icon.toggleClass('far fas');
                        btn.toggleClass('text-danger');
                    }
                });
        });

        // Comment button click
        card.find('.comment-btn').click(function () {
            const commentsSection = card.find('.comments-section');
            const commentsContainer = commentsSection.find('.comments-container');

            // Focus on comment input
            card.find('.comment-input').focus();

            // Load comments if not already loaded
            if (!loadedComments.has(postId)) {
                loadComments(postId, commentsContainer);
            }
        });

        // Comment input interaction
        const commentInput = card.find('.comment-input');
        const commentActions = card.find('.comment-actions');

        commentInput.on('focus', function () {
            commentActions.removeClass('d-none');
        }).on('input', function () {
            const submitBtn = commentActions.find('.submit-comment');
            submitBtn.prop('disabled', !this.value.trim());
        });

        // Cancel comment
        card.find('.cancel-comment').click(function () {
            commentInput.val('');
            commentActions.addClass('d-none');
        });

        // Submit comment
        card.find('.submit-comment').click(function () {
            submitComment(postId, card);
        });

        // Comment input enter key
        commentInput.keypress(function (e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                const submitBtn = card.find('.submit-comment');
                if (!submitBtn.prop('disabled')) {
                    submitComment(postId, card);
                }
            }
        });

        // Track view
        $.post(`/feeds/api/posts/${postId}/view/`);
    }

    function submitComment(postId, card) {
        const commentInput = card.find('.comment-input');
        const content = commentInput.val().trim();
        const commentActions = card.find('.comment-actions');
        const commentsContainer = card.find('.comments-container');

        if (!content) return;

        $.post(`/feeds/api/posts/${postId}/comment/`, { content: content })
            .done(function (response) {
                if (response.status === 'success') {
                    appendComment(commentsContainer, response.comment);
                    commentInput.val('');
                    commentActions.addClass('d-none');

                    // Update comment count
                    const commentCount = card.find('.post-comments span');
                    commentCount.text(parseInt(commentCount.text()) + 1);

                    // Ensure comments are marked as loaded
                    loadedComments.set(postId, true);
                }
            })
            .fail(function (xhr) {
                console.error('Error posting comment:', xhr);
                // You might want to show an error message to the user
            });
    }

    function loadComments(postId, container) {
        const loadingSpinner = $('<div class="text-center my-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>');
        container.prepend(loadingSpinner);

        $.get(`/feeds/api/posts/${postId}/`)
            .done(function (response) {
                if (response.status === 'success' && response.post.comments) {
                    loadingSpinner.remove();
                    response.post.comments.forEach(comment => {
                        appendComment(container, comment);
                    });
                    loadedComments.set(postId, true);

                    // Show/hide comments toggle based on comment count
                    const commentsToggle = container.siblings('.comments-toggle');
                    if (response.post.comments.length > 3) {
                        commentsToggle.removeClass('d-none');
                    }
                }
            })
            .fail(function (xhr) {
                console.error('Error loading comments:', xhr);
                loadingSpinner.remove();
                // You might want to show an error message
            });
    }

    function appendComment(container, commentData) {
        const template = document.getElementById('commentTemplate');
        const commentElement = template.content.cloneNode(true);
        const comment = commentElement.querySelector('.comment');

        // Set comment data
        comment.dataset.commentId = commentData.id;
        comment.querySelector('.comment-avatar').src = commentData.user.avatar_url;
        comment.querySelector('.comment-username').textContent = commentData.user.username;
        comment.querySelector('.comment-content').textContent = commentData.content;
        comment.querySelector('.comment-date').textContent = formatDate(commentData.created_at);

        // Show/hide delete option based on ownership
        if (commentData.user.id !== window.currentUserId) {
            comment.querySelector('.comment-options').remove();
        }

        // Setup comment interactions
        setupCommentInteractions($(comment), commentData.id);

        // Add comment to container
        container.append(comment);
    }

    function setupCommentInteractions(commentElement, commentId) {
        // Like comment
        commentElement.find('.comment-like-btn').click(function () {
            const btn = $(this);
            $.post(`/feeds/api/comments/${commentId}/like/`)
                .done(function (response) {
                    if (response.status === 'success') {
                        btn.toggleClass('text-primary');
                    }
                });
        });

        // Delete comment
        commentElement.find('.comment-delete').click(function () {
            if (confirm('Are you sure you want to delete this comment?')) {
                $.post(`/feeds/api/comments/${commentId}/delete/`)
                    .done(function (response) {
                        if (response.status === 'success') {
                            const postCard = commentElement.closest('.post-card');
                            const commentCount = postCard.find('.post-comments span');
                            commentCount.text(parseInt(commentCount.text()) - 1);
                            commentElement.remove();
                        }
                    });
            }
        });

        // Reply to comment (if you want to implement nested comments)
        commentElement.find('.comment-reply-btn').click(function () {
            const postCard = commentElement.closest('.post-card');
            const commentInput = postCard.find('.comment-input');
            const username = commentElement.find('.comment-username').text();

            commentInput.val(`@${username} `).focus();
        });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        // Less than 1 minute
        if (diff < 60000) {
            return 'Just now';
        }

        // Less than 1 hour
        if (diff < 3600000) {
            const minutes = Math.floor(diff / 60000);
            return `${minutes}m`;
        }

        // Less than 24 hours
        if (diff < 86400000) {
            const hours = Math.floor(diff / 3600000);
            return `${hours}h`;
        }

        // Less than 7 days
        if (diff < 604800000) {
            const days = Math.floor(diff / 86400000);
            return `${days}d`;
        }

        // Otherwise return formatted date
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
        });
    }

    function loadSuggestedUsers() {
        $.get('/feeds/api/suggested-users/')
            .done(function (response) {
                const container = $('#suggestedUsers');
                response.users.forEach(user => {
                    container.append(`
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex align-items-center">
                            <img src="${user.avatar_url}" class="rounded-circle me-2" style="width: 32px; height: 32px;">
                            <div>
                                <h6 class="mb-0">${user.username}</h6>
                                <small class="text-muted">${user.followers_count} followers</small>
                            </div>
                        </div>
                    </a>
                `);
                });
            });
    }
</script>
{% endblock %}